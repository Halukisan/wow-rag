⽂件 常考知识点 UNIX相关知识 1、UNIX采⽤树型⽬录结构,⽂件信息存放在索引节点中,超级块是⽤来描述⽂件系统的 2、UNIX系统所有设备都被视为特殊的⽂件 3、UNIX每个⽬录⽂件中,默认有两个⽬录项,"."表示当前目录,".."表示父目录 各种表,图 1、打开⽂件表:存放已打开⽂件信息的表,将指名⽂件的属性从外存复制到内存,再使⽤该⽂件时直接返回索引 2、位图:详⻅磁盘管理⽅法 3、空闲盘链表:详⻅磁盘管理⽅法 4、索引表:记录每个⽂件所存放的盘块地址 5、系统调⽤表:是⼀张由指向实现各种系统调⽤的内核函数的函数指针组成的表,该表可以基于系统调⽤函数进⾏索引,来定位函数地址,完成系统调⽤

文件性能相关 - 与单个⽂件⻓度/⼤⼩有关的因素:⽂件块⼤⼩,地址项个数,间接地址索引的级数(索引节点总数与单个⽂件⼤⼩⽆关)

- 提⾼⽂件访问速度的⽅法:提前读,延迟写,为⽂件分配连续的簇,采⽤磁盘⾼速缓存

- ⽂件在磁带上采⽤连续存放⽅式;在硬盘上不采⽤连续存放⽅法;在内存上采⽤随机存放⽅法

- 连续结构的⽂件数据读最快,链式的⽅法不能随机存取,索引的⽅法占⾯积 文件打开相关 - ⽂件打开open是把FCB读到内存,不是把⽂件内容读到内存(即不会读⼊⽂件数据,只有⽤read的时候才会读数据)

- open参数包含⽂件名

- read/write参数不包含⽂件名,⽽是open返回的⽂件索引 文件保护相关 - 防⽌⽂件受损的⽅法---->备份;

- ⽤于多⽤户之间的存取权限保护---->存取控制矩阵⽅法 其他 - 系统级安全管理包括注册和登陆

- ⽤户确定⽂件的逻辑结构,由操作系统设计者根据⽂件存储器的特性确定⽂件的物理结构,⼀旦确定,由操作系统管理 基本概念 文件是什么? - ⽂件是以硬盘为载体的存储在计算机上的信息集合

- ⽂件可以是⽂本⽂档,图⽚,程序

- ⽤户进⾏的输⼊输出中,以⽂件为基本单位 文件由什么组成? 1. ⼀块存储空间 2. 分类和索引的信息 3. 关于访问权限的信息 文件有什么特性? 1. 可以⻓期存储在硬盘中 2. 允许可控制的进程间共享访问 3. 能够被组织成复杂的结构 文件的属性/元数据 - ⽂件名;⽂件类型

- 创建者;所有者

- 位置;⼤⼩;保护;创建信息

⽂件的数据结构 目录项 相关概念 - ⽬录项/FCB = ⽤来记录⽂件的名字,索引节点指针以及其他⽬录项的层级关联关系

- ⽬录/⽬录⽂件 = FCB的集合

- 为了实现"按名存取",在⽂件系统中为每个⽂件设置⽤于描述和控制⽂件的数据结构,称作⽂件控制块FCB,也叫做⽬录项

- ⽬录也被视作⼀个⽂件,该⽂件叫做⽬录⽂件

- ⽬录项是由内核维护的⼀个数据结构,缓存在内存,⽬录项⽂件存储在磁盘

- ⽬录⽂件存放该⽬录中所有⼦⽬录⽂件和数据⽂件的⽬录 包含信息 - 基本信息:⽂件名;⽂件物理位置,⽂件逻辑结构,⽂件物理结构

- 存取控制信息:⽂件主或核准⽤户或⼀般⽤户的存取权限

- 使⽤信息:⽂件创⽴时间,上次修改时间 索引节点 概念 - 索引节点是⽤来记录⽂件的元信息,是⽂件的唯⼀表示

- 索引节点同样占⽤磁盘空间

- 将⽂件描述信息从⽬录项中分离,即应⽤了索引节点的⽅法

- 使⽤索引节点可以减少查找⽂件时的I/O信息量 分类 磁盘索引节点

- 指存放在磁盘上的索引节点,每个⽂件有⼀个唯⼀的磁盘索引节点

- 包含内容:⽂件主标识符;⽂件类型;⽂件存取权限;⽂件物理地址;⽂件⻓度;⽂件链接计数;⽂件存取时间 内存索引节点

- 指存放在内存中的索引节点,⽂件打开后,将磁盘索引节点复制到内存中

- 新增内容:索引节点编号;状态;访问计数;逻辑设备号;链接指针 示例图

⽂件的操作 基本操作 - 创建⽂件;写⽂件;读⽂件;重新定位⽂件;删除⽂件;截断⽂件 文件打开的过程 ⽂件打开就是调⽤open,根据⽂件名搜索⽬录,将指明⽂件的属性(包括该⽂件在外上的物理地址)

从外存复制到内存打开⽂件表的⼀个表⽬中,并将该表⽬的编号(也叫索引)返回给⽤户

•

- 【打开⽂件操作的主要⼯作就是把指定⽂件的⽬录复制到内存指定的区域】

- 【open操作会把⽂件的FCB调⼊内存,⽽不会把⽂件内容读到内存,只有进程希望获取⽂件内容时才会读⼊⽂件内容】

文件打开和关闭关联的信息 ⽂件指针;⽂件打开计数;⽂件磁盘位置;访问权限

 ⽂件描述符是打开⽂件的标识

•

写入文件的过程【举例】 例图 代码 fd	=open(name,flag);\#	打开文件 write(fd,...);\#	写数据 read(fd,...);\#	读数据 close(fd);\#	关闭文件 解释 - ⾸先⽤ open 系统调⽤打开⽂件,open 的参数中包含⽂件的路径名和⽂件名

- 使⽤ write 写数据,其中 write 使⽤ open 所返回的⽂件描述符,并不使⽤⽂件名作为参数【read同理,结合C语⾔⽂件读写代码记忆】

- 使⽤完⽂件后,要⽤ close 系统调⽤关闭⽂件,避免资源的泄露

⽂件的保护 1. 保护的⽬的: 解决对⽂件的读,写,执⾏的许可问题 2. ⼀个⽂件的访问常由⽤户访问权限和⽂件属性(包括保存在FCB中对⽂件访问的控制信息)共同设置 3. 保护的⽅式 非访问控制方法 1.⼝令 2.加密保护 定义 - ⽤户建⽴⼀个⽂件时需要提供⼝令

- ⽤户请求访问时必须提供相应⼝令

- 对⽂件进⾏加密,访问时需要密钥 优点 - 时间空间开销不多 - 保密性强,节省了存储空间 缺点 - ⼝令直接存在系统内部,不安全 - 编码和译码需要时间 访问控制方法 - 访问控制的⽬的:⽤于控制⽤户对⽂件的访问⽅式

- 访问控制的对象:读;写;执⾏;添加;删除;列表清单

- 访问控制机制必须由系统实现

⽅法⼀ ⽅法⼆

定义 - 为每个⽂件和⽬录增加⼀个访问控制列表ACL

- 该表规定每个⽤户名及其所允许的空间管理

- 采⽤精简的访问列表

- 该列表采⽤拥有者,组和其他三种⽤户类型 优点 - 可以使⽤复杂的访问⽅法 - 只需要三个域即可列出访问表中这三类⽤户的访问权限 缺点 - ⻓度⽆法预计并且可能导致复杂的空间管理

⽂件的逻辑结构【⽤户⻆度的⽂件组织形式】

定义 - 即⽂件中的数据在逻辑层⾯是如何组织起来的 无结构文件/流式文件 - 最简单的⽂件组织形式,是有序相关信息项的集合,以字节为单位

- 对基本信息单元操作不多的⽂件适合该⽅式,如源代码⽂件,⽬标代码⽂件 有结构文件/记录式文件 1.顺序⽂件 - 串结构:只能按顺序查找,费时

- 顺序结构:可采⽤折半查找,检索效率⾼

顺序查找平均次数!

"

;索引顺序查找平均次数N

!

- "

2.索引⽂件 - 提⾼了存取速度,但索引表增加了存储空间 3.索引顺序⽂件 - 提同⼀组中的关键字可以⽆序,但组与组之间的关键字必须有序

- 先通过索引表查找所在的组,然后再该组中使⽤顺序查找

⽂件的物理结构【⽂件在外存上的存储组织形式】

- 关于这⼀部分的详细介绍可以看这篇博客:⽂件的存储 定义 - 研究⽂件数据在物理存储设备上是如何分布和组织的

- ⽂件在磁带上--->连续存放⽅式

- ⽂件在磁盘上--->不采⽤连续存放⽅式

- ⽂件在内存上--->随机存放⽅式 文件的存储方式 - ⽂件的存储就是对磁盘⾮空闲块的管理

•

1、顺序分配【类似数组】 2、链表分配【类似链表】 3、索引分配【类似索引表】

- ⽂件头需指定起始块的位置和⻓度

- 要求连续的存储空间

- 可随机访问
- 存放是离散的,不⽤连续的,于是就可以消除磁盘碎⽚
- 可⼤⼤提⾼磁盘空间的利⽤率,同时⽂件的⻓度可以动态扩展

- 隐式链接⽆法直接访问数据块,只能通过指针顺序访问⽂件

- 显式链接把⽤于链接⽂件各数据块的指针,显式地存放在内存的⼀张链接表中

- 内存中的这样⼀个表格称为⽂件分配表FAT(File Allocation Table)

- 不可随机访问

- 为每个⽂件创建⼀个「索引数据块」

- ⾥⾯存放的是指向⽂件数据块的指针列表

- 像书的⽬录⼀样,要找哪个章节的内容,看⽬录查就可以

- 可随机访问 4、链表 + 索引 5、索引+索引(多级索引) 多级索引举例-->unix系统的inde结构
- 索引数据块留出⼀个存放下⼀个索引数据块的指针 - 通过⼀个索引块来存放多个索引数据块 - 对于⼩⽂件使⽤直接查找的⽅式可减少索引数据块的开销

- 对于⼤⽂件则以多级索引的⽅式来⽀持

- 所以⼤⽂件在访问数据块时需要⼤量查询

- 存放⽂件所需的数据块⼩于 10 块,则采⽤直接查找的⽅式

- 存放⽂件所需的数据块超过 10 块,则采⽤⼀级间接索引⽅式

- 前⾯两种⽅式都不够存放⼤⽂件,则采⽤⼆级间接索引⽅式

- ⼆级间接索引也不够存放⼤⽂件,则采⽤三级间接索引⽅式

- 图⻅博客或者王道书...

文件的存储空间管理 - ⽂件的存储空间管理就是对磁盘空闲块的管理

- Linux ⽂件系统就采⽤了位图的⽅式来管理空闲空间,不仅⽤于数据空闲块的管理,还⽤于 inode 空闲块的管理,因为 inode 也是存储在磁盘的 1、空闲表法 - 为所有空闲空间建⽴⼀张表
- 表内容包括空闲区的第⼀个块号和该空闲区的块个数 2、空闲链表法 - 每⼀个空闲块⾥有⼀个指针指向下⼀个空闲块
- 这样能很⽅便的找到空闲块并管理起来 3、位图法 - 位图是利⽤⼆进制的⼀位来表示磁盘中⼀个盘块的使⽤情况
- 磁盘上所有的盘块都有⼀个⼆进制位与之对应
- 当值为 0 时,表示对应的盘块空闲
- 值为 1 时,表示对应的盘块已分配

- 通常可⽤m*n个位数来构成m⾏n列的位示图

- 且m*n等于磁盘的总块数 4、成组链法 - 结合空闲表和空闲链表的优点,克服表⻓的缺点

⽂件系统 基本概念和⽬标 概念 - ⽂件系统 = OS中负责管理持久数据的⼦系统

- ⽂件系统 = 与⽂件管理有关的软件 + 被管理的⽂件 + 试试⽂件管理所需的数据结构

- ⽂件系统需先挂在到某个⽬录才可正常使⽤

- ⽂件的基本操作单位就是数据块 目标 1. 实现对⽂件的基本操作 = 按名存储和查找⽂件 + 组织成合适的结构 + ⽂件共享 + ⽂件保护【⽤户⻆度】

2. 管理与磁盘的信息交换 + 完成逻辑结构和物理结构的变换【OS⻆度】

3. 组织⽂件在磁盘上的存放 + 采取好的⽂件排放顺序和磁盘调度⽅法【OS⻆度】

分类 磁盘的⽂件系统 - 它是直接把数据存储在磁盘中,⽐如 Ext 2/3/4、XFS 等都是这类⽂件系统 内存的⽂件系统 - 这类⽂件系统的数据不是存储在硬盘的,⽽是占⽤内存空间

- 我们经常⽤到的 /proc 和 /sys ⽂件系统都属于这⼀类

- 读写这类⽂件,实际上是读写内核中相关的数据

⽹络的⽂件系统 - ⽤来访问其他计算机主机数据的⽂件系统,⽐如 NFS、SMB 等等

⽂件系统的层次结构 主要功能和介绍 I/O控制 设备驱动程序 - 将输⼊的命令翻译成底层硬件的特定指令 中断处理程序 - 利⽤指令使IO设备与系统交互 基本文件系统 - 向对应的设备驱动程序发送通⽤命令,以读取和写⼊磁盘的物理块

- 管理内存缓冲区,保存各种⽂件系统,⽬录和数据块的缓冲 文件组织模块 - 组织⽂件及其逻辑块和物理块

- 可以将逻辑地址转换为物理地址

- 有空闲空间管理器,以跟踪未分配的块,根据需要提供给⽂件组织模块 逻辑文件系统 - ⽤于管理元数据信息(包括⽂件系统的所有结构,不包括⽂件内容)

- 管理⽬录结构

- 通过FCB维护⽂件结构

- 负责⽂件保护

⽂件系统的布局 在磁盘中的结构

- 最前⾯的第⼀个块是引导块,在系统启动时⽤于启⽤引导

- 接着后⾯就是⼀个⼀个连续的块组了,块组的内容如下 超级块 - 包含的是⽂件系统的重要信息

- ⽐如 inode 总个数、块总个数、每个块组的 inode 个数、每个块组的块个数 块组描述符 - 包含⽂件系统中各个块组的状态

- ⽐如块组中空闲块和 inode 的数⽬等,每个块组都包含了⽂件系统中「所有块组的组描述符信息」

数据位图 inode 位图

- ⽤于表示对应的数据块或 inode 是空闲的,还是被使⽤中 inode 列表 - 包含了块组中所有的 inode,inode ⽤于保存⽂件系统中与各个⽂件和⽬录相关的所有元数据 数据块 - 包含⽂件的有⽤数据 在内存中的结构 - 内存中的信息⽤于管理⽂件系统并通过缓存来提⾼信息 这些结构有以下类型

- 内存中的安装表

- 内存中的⽬录结构的缓存包含最近访问⽬录的信息

- 整个系统的打开⽂件表

- 每个进程的打开⽂件表

•

虚拟⽂件系统VFS

目的 - 为用户程序提供了文件系统操作的统一接口,屏蔽了不同文件系统差异和操作细节 特性 1. 能提高系统性能 2. 不是一种实际的文件系统 3. 只存在于内存中,不存在与任何外存空间中 4. 在系统启动时建立,在系统关闭时消亡 VFS的数据结构 1. 超级块对象 2. 索引节点对象 3. 目录项对象 4. 文件对象

⽤户空间,系统调⽤,虚拟⽂件系统,缓存,⽂件系统和存储之间的关系 分区和安装

- ⼀个磁盘可划分为多个区,每个分区都可以创建单独的⽂件系统,每个分区都可包含不同的操作系统

- ⽂件在使⽤前必须先安装(即挂载)

⽬录 常考点 目录结构相关 1、在树型⽬录中,为了加快⽂件检索速度,可设置当前⽬录,于是⽂件路径可以从当前⽬录开始查找 2、⽂件系统采⽤多级⽬录的⽬的是解决命令冲突 3、树形⽬录结构中,⽤户对⽂件的⾸次访问通常采⽤⽂件路径名,之后对⽂件的访问通常使⽤⽂件描述符 目录检索相关 - 在顺序检索法时,只要路径名的⼀个分量名未找到,就应停⽌查找 文件共享相关 - ⽤户进程的打开⽂件表关于同⼀个⽂件不⼀定相同,例如读写指针位置不⼀定相同 其他 - 整个⽂件系统只有⼀个系统⽂件打开表(⾥⾯的表项都是不重复的),同⼀⽂件打开多次只需改变引⽤计数

⽬录管理要求 1. 实现"按名存取" 2. 要提⾼⽬录的检索速度 3. 需要提供⽤于控制访问⽂件的信息 4. 允许不同⽤户对不同⽂件采⽤系统的名字

⽬录结构 定义 优点 缺点 结构图 单级目录结构 - 整个⽂件系统只建⽴⼀张⽬录表

- 每个⽂件占⼀个⽬录项
- 查找速度慢
- ⽂件不允许重名

- 不便于⽂件共享

- 不适合多⽤户的OS

两级目录结构 - ⽂件⽬录分为主⽂件⽬录MDF和⽤户⽂件⽬录UFD

- MDF记录⽤户名UFD所在的存储位置

- UFD记录⽤户⽂件的FCB信息
- 解决了多⽤户之间的⽂件重名问题
- ⽂件系统可以在⽬录上实现访问限制

- 缺乏灵活性,不能对⽂件分类 型目录结构 - 使⽤绝对路径,相对路径,当前路径的结构

- 不同的⽤户的⽂件,⽂件名可相同可不同

- ⼤多OS采⽤这种⽬录结构

- 可以很⽅便的对⽂件进⾏分类

- 能够有效地进⾏⽂件的管理和保护

- 利于⽂件共享

- 查找⽂件增加了磁盘访问次数,会影响查询速度 无环图目录结构 - 在树形⽬录结构上

- 加⼊有向边,组成⼀个有向⽆环图
- 实现了⽂件共享 - 使系统的管理变得更加复杂
⽬录的操作 搜索⽂件 修改⽬录 创建⽂件 创建⽬录 删除⽬录 移动⽬录 显示⽬录 删除⽂件:删除⼀个⽂件时,会根据FCB回收相应的磁盘空间,将FCB回收,并删除⽬录中对应的⽬录项

⽬录的查询/检索 概念 - ⽬录查询通过在磁盘上反复搜索完成,需要不断进⾏I/O操作,开销⼤

- 可以把当前使⽤的⽂件⽬录复制到内存,从⽽降低磁盘操作次数,提⾼系统速度 实现方法 定义 优点 缺点 线性列表【对应线性查找】 - 采取线性列表存储⽂件⽬录项 - 实现简单 - 查找费时 哈希表【对应散列查找】 - 采取哈希表存储⽂件⽬录项 - 查找迅速,插⼊删除简单 - 需要⼀些措施来避免冲突

⽂件共享 概念 - ⽂件共享使多个⽤户共享同⼀个⽂件,系统只需保留该⽂件的⼀个副本 文件共享方式 基于索引节点的关系⽅式【硬链接】 基于符号链实现⽂件共享【软链接】

定义 - 硬链接就是多个指针指向⼀个索引节点

- ⽂件的物理地址和其他⽂件属性信息放在索引节点中

- 软链接相当于重新创建⼀个⽂件

- 新⽂件只包含被链接⽂件的路径名 特点 - 硬链接不可⽤于跨⽂件系统

- 硬链接查找速度⽐软链接快
- 软链接可以跨⽂件系统 新增⽂件时 - 建⽴硬链接时,引⽤计数值加1 - 符号链接,计数值直接复制 删除⽂件时 - 删除⽂件时,计数值减1

- 若得到的值不为0,则不能删除此⽂件

- 即只要还有⼀个指针在,索引节点就不会被删除

- 删除操作对符号链接不可⻅

- 以后再通过符号链接访问时,若发现⽂件不存在,直接删除符号链接 示例 快捷⽅式属于⽂件共享中的软链接 本章常⻅的计算 1 .位示图相关计算 2 .求文件的长度/大小 3.磁盘计算相关

【计算访盘次数】

【计算访问哪个盘】

第四章 ⽂件管理 2022年9月28日 星期三 23:44